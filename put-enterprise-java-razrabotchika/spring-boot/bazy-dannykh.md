# Базы данных

Как уже говорилось в главе [tipichnye-zadachi-v-enterprise-razrabotke.md](../tipichnye-zadachi-v-enterprise-razrabotke.md "mention"), Enterprise разработка - это обычно перекладывание данных из одного хранилища/сервиса в другой, с некоторыми модификациями по дороге.&#x20;

А раз есть данные - надо их где-то и хранить.

В этой главе пробежимся по верхам по основам баз данных и по основам работы с ними в Spring с помощью Hibernate. Глава не претендует на полноту освещения вопроса (так-то он вполне тянет на семестровый университетский курс), но хотя бы позволит понимать, что это за классы в вашем Spring проекте такие, и каким образом ваши Java-объекты где-то там сохраняются.

Хороший набор учебных статей, в котором с самых основ объясняется, что такое БД, какие они бывают, какие технологии используются, есть на сайте [https://database.guide/what-is-a-database/](https://database.guide/what-is-a-database/). В этой главе будут даны лишь некоторые выдержки.

### Виды баз данных

В принципе, базой данных может быть все что угодно. Даже текстовый файлик или экселевская табличка - это уже в каком-то виде БД. Но табличка становится неудобной, когда данных много, надо делать по ним сложные выборки, у данных есть связи и т.п. В итоге люди придумали кучу специфических решений для хранений информации.

По-правильному программный комплекс управляющий БД называется "система управления базами данных", СУБД. Но часто в разговорной речи и саму базу с информацией, и управляющее ей ПО называют просто базой данных, БД.

![Популярность различных систем управления БД, https://db-engines.com/en/ranking](../../.gitbook/assets/image.png)

#### Реляционные БД

В обычной бытовой разработке наиболее популярны т.н. реляционные базы данных, в таблице выше они занимают 7 из 10 верхних строчек. В таких БД объекты представляются в виде таблиц заданной структуры, в которых столбцы - это поля данных, а строки - сами объекты.&#x20;

![Простая реляционная БД - это таблицы, где каждая строка - это один объект в БД](<../../.gitbook/assets/image (5).png>)

Кроме объектов в реляционной БД могут быть связи между ними. Например, на изображении выше таблица Ratings ссылается на записи в таблице Albums через столбец AlbumId. Из нее мы можем узнать, что у альбома с id=2 (то есть Black Ice) рейтинг равен 5. А таблица Albums ссылается на таблицу Artist, пройдя по этой ссылке мы можем узнать, что альбом Black Ice сыгран артистом номер 1, то есть AC/DC

#### SQL

Рука об руку с понятием реляционной БД идет такая вещь как SQL. Это некий универсальный язык запросов (Structured Query Language), позволяющий писать запросы к такой БД для чтения или управления объектами в ней.

SQL это очень популярная и известная вещь, по нему есть тысячи туториалов разной степени сложности. Например, на том же сайте [https://database.guide/sql-tutorial-for-beginners/](https://database.guide/sql-tutorial-for-beginners/), или на русском на Хабре [https://habr.com/ru/post/564390/](https://habr.com/ru/post/564390/)

Сразу отмечу, что понимание основ SQL крайне желательно, как и умение написать простой SELECT/INSERT запрос. Но углубляться в дебри, во всяком случае поначалу, не нужно. Учить всякие JOINы для начала точно не обязательно.

#### Популярные реляционные БД

Сам SQL - это лишь общий стандарт. Существует множество реализаций идеи реляционных БД, при этом они все используют свой собственный вариант SQL, которые часто несовместимы друг с другом. Общие идеи организации данных одинаковы в них всех, однако множество нюансов - по синтаксису языка запросов, по администрированию, по возможностям масштабирования - у разных БД разные.

Наиболее популярными в небольших компаниях являются MySQL и PostgreSQL. Они имеют бесплатные и опенсосные версии, поэтому доступны для всех (в отличие от MSSQL и Oracle, которые предназначены для крупных компаний и стоят дорого).&#x20;

По моему опыту MySQL проще и интуитивно понятнее в установке и настройке, поэтому для небольших проектов и обучения я предпочитаю использовать ее. PostgreSQL несколько сложнее, зато лучше масштабируется и больше подходит крупным проектам. Но это тоже все холиварный вопрос, и пока у вас нет миллионов пользователей, вряд ли вы заметите разницу.

MySQL существует в виде двух вариантов - собственно MySQL и MariaDB. Второе является форком первого, развиваемое независимым сообществом, имеющее меньше лицензионных ограничений. В целом они практически эквивалентны.

В комплекте с MySQL можно скачать MySQL Workbench - GUI клиент для работы с БД.&#x20;

&#x20;

![В MySQL Workbench можно просматривать и редактировать базы данных и таблицы, писать запросы, видеть результаты](<../../.gitbook/assets/image (2).png>)

Аналогичные инструменты существуют и для других СУБД, например pgAdmin для PostgreSQL.

#### Иные виды БД

Кроме реляционных БД существуют и другие виды: документоориентированные, базы "ключ-значение" и иные. Иногда их называют NoSQL, подчеркивая их отличие от реляционных БД, поддерживающих варианты языка SQL.

Из популярного можно назвать, например, MongoDB, Cassandra. Они могут отличаться отсутствием внутренней структуры, возможностью хранить произвольные данные (в отличие от реляционных БД, где структура таблиц жестко задана при создании), заточенностью на более эффективное выполнение отдельных операций на больших объемах данных.

Как правило, это нишевые решения. Несколько лет назад NoSQL были на хайпе, и казалось что они вытеснят классические реляционные БД, но этого не случилось. Более того, многие NoSQL решения в итоге переняли часть фич реляционных БД, например добавили к себе поддержку запросов на упрощенных диалектах SQL. Просто потому, что представление данных в виде объектов и связей между ними удобно для людей, работающих с данными.

#### Встроенные БД

Как правило, СУБД - это отдельное ПО, которое запускается на сервере или ПК, работает в фоновом режиме и обрабатывает приходящие по сети запросы.

Но иногда хочется вставить полноценную БД в какое-нибудь небольшое приложение, например для хранения локального кеша данных (актуально для Android), или для тестирования, чтобы тесты не зависели от внешних сервисов.

Для таких целей есть отдельное множество встроенных СУБД. Среди них могу отметить SQLite и H2. Обе являются встраиваемыми SQL решениями, которые можно использовать в своей Java-программе, без необходимости поднимать какие-то сервера и делать сетевые запросы.

Их возможности часто ограничены по сравнению с "большими" СУБД (хуже производительность на больших объемах, нет поддержки многих удобных SQL конструкций), но для задач локального кеширования они отлично подходят.

### Как работать с SQL БД в Java

#### JDBC

Из коробки в Java есть механизм работы с SQL БД, называемый JDBC - Java Database Connectivity. Это набор низкоуровневых классов, которые оборачивают создание подключения к БД, отправку SQL запросов и получение результатов.

Кроме базовых классов, идущих в комплекте с JDK, понадобится так же библиотека с реализацией для конкретной СУБД. Например, для подключения к MySQL понадобится зависимость mysql-connector-java

Туториалов по JDBC в сети полно, например [https://www.baeldung.com/java-jdbc](https://www.baeldung.com/java-jdbc) и [https://www.baeldung.com/java-jdbc](https://www.baeldung.com/java-jdbc) и [https://javarush.ru/groups/posts/2172-jdbc-ili-s-chego-vsje-nachinaetsja](https://javarush.ru/groups/posts/2172-jdbc-ili-s-chego-vsje-nachinaetsja). Технология достаточно старая и последние годы не изменялась.

Для простого приложения, работающего с 1-2 таблицами и не имеющего серьезной нагрузки, этого может быть достаточно. Однако в более сложном приложении сразу начинаются сложности:

* Java-объекты в реальном приложении могут быть сложными, со множеством полей и связей, писать вручную SQL запросы для них утомительно и чревато ошибками.
* Ручное управление соединениями с БД быстро становится неэффективным и неудобным. Появляется необходимость переиспользовать соединения, кэшировать запросы и их результаты для повышения производительности.&#x20;

Для решения этих проблем создан ряд технологий и фреймворков

#### ORM

Первую проблему - сложность в превращении объектов из ООП языка программирования в таблицы и запросы к реляционной БД - решают т.н. ORM фреймворки - Object-Relational Mapping.

Такие фреймворки есть в разных языках программирования и все работают примерно одинаково. Вы описываете классы сущностей, которые должны храниться в БД. Фреймворк на основе этого описания (это может быть просто код класса, код со специальными аннотациями, описание в виде XML или в любом другом формате) сам генерирует все необходимые SQL запросы, сам создает необходимую структуру БД.

Для Java существует несколько таких ORM фреймворков:

* Hibernate - наиболее мощный и популярный, про него будет рассказано в следующей главе
* Room - идет "из коробки" в последних версиях Android SDK. Намного более простой и примитивный, годится для простых БД
* OrmLite - еще один "простой" фреймворк, тоже часто используется в Android&#x20;
* И еще много всяких, разной степени популярности.

#### Пулы соединений&#x20;

Создание подключения к БД - довольно дорогостоящая с точки зрения производительности вещь. Если в простом приложении вполне нормально открывать соединение на каждый запрос, и закрывать его после исполнения, то в нагруженном веб-сервисе это приведет к ощутимому падению скорости выполнения запросов.

Для решения этой проблемы есть различные реализации пулов соединений. В таких пулах поддерживается набор открытых соединений, которые не закрываются после выполнения запроса, а переиспользуются снова и снова.

Обзор популярных решений можно найти в статье [https://www.baeldung.com/java-connection-pooling](https://www.baeldung.com/java-connection-pooling)

Стоит отметить, что хотя ORM фреймворки используют пулы соединений внутри себя, можно использовать их и отдельно. Например, в вашем приложении есть только простые SQL запросы, ORM вам не нужен, но важна производительность - в таком случае вы можете использовать "голый" пул соединений, и писать запросы в него вручную.

### Заключение

Итак, в этой главе по верхам пробежались по основным технологиям работы с базами данных в Java. Каждая из рассмотренных технологий сама по себе может потребовать отдельного курса для изучения, но теперь вы хотя бы будете знать, какие именно ключевые слова искать самостоятельно.

В следующей главе рассмотрим подробнее Hibernate - стандарт де-факто в работе с БД в Java Enterprise разработке.

